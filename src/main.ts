import * as core from '@actions/core'
import * as github from '@actions/github'
import {graphql} from '@octokit/graphql'

async function run(): Promise<void> {
  try {
    const {alerts} = await graphql(
      `
        query VulnerabilityAlerts($repo: String!, $owner: String!) {
          repository(name: $repo, owner: $owner) {
            vulnerabilityAlerts(first: 100) {
              nodes {
                createdAt
                dismissedAt
                state
                securityVulnerability {
                  package {
                    name
                  }
                  advisory {
                    description
                  }
                }
              }
            }
          }
        }
      `,
      {
        repo: github.context.repo.repo,
        owner: github.context.repo.owner,
        headers: {
          authorization: `token ${process.env.AUTH_TOKEN}`
        }
      }
    )

    core.setOutput('alerts', alerts)
    core.setOutput('repo', github.context.repo.repo)
    core.setOutput('owner', github.context.repo.owner)
  } catch (error) {
    if (error instanceof Error) core.setFailed(error.message)
  }
}

run()
